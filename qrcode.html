<script type="text/javascript" src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style type="text/css">
    #preview {
        -moz-transform: scaleX(-1);
        -o-transform: scaleX(-1);
        -webkit-transform: scaleX(-1);
        transform: scaleX(-1);
    }
</style>

<div class="float-right">
    <a href="javascript: void();" onclick="iniciarLeitor(true)" id="mudarCamera" class="btn btn-warning"> Mudar câmera</a>
</div>
<video id="preview" style="width: 100%; height: 80%;"></video>
<script>
    var scanner = new Instascan.Scanner({
        video: document.getElementById('preview')
    });
    scanner.addListener('scan', function(content) {
        window.location = 'finalizarregistro/' + content;
    });

    function iniciarLeitor(force = false) {
        var favorite_cam = localStorage.getItem('favorite_cam') || false;

        if (favorite_cam !== false) {
            if (force === false) {
                Instascan.Camera.getCameras().then(async cameras => {
                    scanner.start(cameras[favorite_cam]);
                });
                return true;
            }
        }

        Instascan.Camera.getCameras().then(async cameras => {
            if (cameras.length > 0) {
                if (cameras.length < 3) {
                    var inputOptions = []
                    for (let i = 0; i < cameras.length; i++) {
                        inputOptions.push(i + ' - ' + cameras[i].name)
                    }

                    const {
                        value: option
                    } = await Swal.fire({
                        title: 'Selecione uma camera',
                        input: 'select',
                        inputOptions: inputOptions,
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Você precisa escolher uma camera!'
                            }
                        }
                    })

                    if (option) {
                        scanner.start(cameras[option]);
                        localStorage.setItem("favorite_cam", option)
                    }



                } else {
                    scanner.start(cameras[0]);
                }
            } else {
                console.error("Não existe câmera no dispositivo!");
            }
        });
    }

    iniciarLeitor(false);
</script>